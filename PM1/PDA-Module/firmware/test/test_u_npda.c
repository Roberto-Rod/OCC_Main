/* ************************************************************************** */
/** @file test_u_npda.c
 *
 *  @brief Unit tests verifying npda.c module.
 *
 *  @copyright Occuity Limited (c) 2020
 */
/* ************************************************************************** */

#ifndef TEST_FILE_C /* Guard against accidental multiple inclusion */
#define TEST_FILE_C

/* ************************************************************************** */
/* Section: Included Files                                                    */
/* ************************************************************************** */

/* Header file for selective initialisation of hardware modules. */
#include "init_minimum_plus_timer.h" 
/* Library containing the test harness. */
#include "unity.h" 

/* ************************************************************************** */
/* Include additional files to compile here                                   */
/* ************************************************************************** */
//TEST_FILE("file_to_compile.c")

/* ************************************************************************** */
/* Include files to test here                                                 */
/* ************************************************************************** */
#include "pdab_types.h"
#include "test_m_npda_scan_data_01.h"
#include "test_m_npda_cal_data_01.h"
#include "npda_tools.h"
#include "npda.h"

/* ************************************************************************** */
/* Section: File Scope or Global Data                                         */
/* ************************************************************************** */

/* ************************************************************************** */
/* Section: Local Functions                                                   */
/* ************************************************************************** */

/* ************************************************************************** */
/* Section: Interface Functions                                               */
/* ************************************************************************** */

/* ************************************************************************** */
/** 
 * @brief            This function contains code to be executed before unit
 *                   tests.
 *
 * @note             For testing npda.c nothing needs to be set up. 
 */
/* ************************************************************************** */
void setUp(void)
{
}

/* ************************************************************************** */
/** 
 * @brief            This function contains code to be executed after unit
 *                   tests.
 *
 * @note             For testing npda.c nothing needs to be set up. 
 */
/* ************************************************************************** */
void tearDown(void)
{
}

/* ************************************************************************** */
/** 
 * @brief            npda_scan()
 *
 * @test             This is to test whether the npda_scan()
 *                   function returns correct values when presented with sample
 *                   scan data.
 * 
 * @note             None.
 */
/* ************************************************************************** */
void test_npda_scan_correct_data()
{
    int iret;
    int scan_count = 0;
    uint16_t npda_avg_len = 0;
    unsigned int valid_scan_cnt = 0;
    word scan_med =  20193; //In MATLAB it is 20192.6, therefore all results will be 0.4 lower compared to MATLAB
    word * offsets = (word *)&scanData.Positions;

    fptype expected_npda_avg[] = {0.060840000000000, 0.059359999999999, 0.056649090909090, 0.049121818181819, 0.044440000000000, 0.039879999999996,
0.033449090909091, 0.037403636363637, 0.041312727272727, 0.038849090909090, 0.037940000000000, 0.039849090909091,
0.043476363636364, 0.042728888888888, 0.038040000000000, 0.034065000000000, 0.036939999999999, 0.039073333333334,
0.041462222222222, 0.046706666666668, 0.052262222222222, 0.050140000000001, 0.052740000000000, 0.054340000000000,
0.044540000000000, 0.039740000000001, 0.042240000000000, 0.039669999999999, 0.035360000000000, 0.035170000000001,
0.040690000000001, 0.048062222222223, 0.055120000000000, 0.065420000000004, 0.073300000000000, 0.075600000000000,
0.085360000000000, 0.085951111111113, 0.088719999999999, 0.086119999999998, 0.079399999999999, 0.071429999999999,
0.067399999999999, 0.064540000000000, 0.063740000000000, 0.062600000000001, 0.065980000000001, 0.070300000000000,
0.073880000000000, 0.074600000000001, 0.078940000000002, 0.083985454545455, 0.086520000000000, 0.085230909090908,
0.084094545454545, 0.082180000000000, 0.077976363636363, 0.081549090909090, 0.079640000000000, 0.082549090909091,
0.091029999999998, 0.088503636363635, 0.083594545454544, 0.078773333333333, 0.075973333333334, 0.081040000000000,
0.080252499999999, 0.079073333333333, 0.083917777777776, 0.096528888888893, 0.105440000000001, 0.107140000000000,
0.107876363636363, 0.106294545454545, 0.103158181818181, 0.100212727272727, 0.099340000000000, 0.099921818181818,
0.103849090909094, 0.111703636363637, 0.116030909090909, 0.119109999999999, 0.118229999999998, 0.113117777777778,
0.115184444444445, 0.116377500000003, 0.125662222222222, 0.131040000000001, 0.134206666666667, 0.129540000000001,
0.130428888888887, 0.125251111111111, 0.123940000000000, 0.123690000000000, 0.123809999999999, 0.122473333333334,
0.126620000000000, 0.131460000000001, 0.136780000000002, 0.142760000000000, 0.144517777777778, 0.147540000000001,
0.151794545454546, 0.153830909090909, 0.148694545454543, 0.140260000000002, 0.142449090909087, 0.133212727272726,
0.125940000000000, 0.125239999999998, 0.122421818181817, 0.123530909090909, 0.131520000000000, 0.144284444444448,
0.157540000000006, 0.169940000000001, 0.177440000000000, 0.183140000000002, 0.185195555555555, 0.190240000000003,
0.195706666666667, 0.206662222222220, 0.227740000000005, 0.245649090909092, 0.263903636363639, 0.278119999999999,
0.289476363636367, 0.296840000000001, 0.306203636363638, 0.317160000000000, 0.322258181818183, 0.327067272727274,
0.334873333333333, 0.332740000000001, 0.329273333333332, 0.329606666666667, 0.335806666666668, 0.339017777777778,
0.341017777777778, 0.342040000000000, 0.341595555555554, 0.334440000000000, 0.332417777777776, 0.327669999999997,
0.319380000000000, 0.314120000000002, 0.301749999999997, 0.287873333333330, 0.275020000000000, 0.267620000000000,
0.258219999999996, 0.246379999999996, 0.231300000000000, 0.218240000000000, 0.204599999999993, 0.189519999999996,
0.177400000000000, 0.169759999999999, 0.161799999999997, 0.159340000000001, 0.163500000000000, 0.176280000000000,
0.196340000000007, 0.216640000000007, 0.249220000000000, 0.282980000000000, 0.320680000000025, 0.370180000000009,
0.414180000000000, 0.468920000000000, 0.516520000000016, 0.572380000000022, 0.653520000000000, 0.744120000000000,
0.861480000000000, 0.987079999999978, 1.106919999999947, 1.229479999999944, 1.356539999999943, 1.486119999999977,
1.618639999999940, 1.752939999999940, 1.897295555555469, 2.056839999999965, 2.198339999999972, 2.334239999999934,
2.471889999999915, 2.604189999999969, 2.731789999999974, 2.865939999999933, 2.996739999999925, 3.106089999999976,
3.201939999999981, 3.277989999999969, 3.344789999999956, 3.406989999999986, 3.455389999999991, 3.490839999999985,
3.516439999999988, 3.531028888888884, 3.531560000000002, 3.519020000000007, 3.495660000000012, 3.458380000000011,
3.404160000000027, 3.335840000000043, 3.260530000000050, 3.187730000000016, 3.107120000000019, 3.012284444444483,
2.920840000000039, 2.826380000000034, 2.727800000000044, 2.621140000000048, 2.491840000000059, 2.364495555555581,
2.244930000000026, 2.153210000000019, 2.028780000000080, 1.937010000000019, 1.837520000000023, 1.737240000000044,
1.673421818181860, 1.590090000000019, 1.510276363636395, 1.441058181818222, 1.369660000000049, 1.306785454545475,
1.246420000000027, 1.190867272727302, 1.148090000000022, 1.102449090909135, 1.046340000000024, 0.990040000000032,
0.905817777777837, 0.855706666666673, 0.831073333333345, 0.792640000000018, 0.758806666666685, 0.729428888888903,
0.699073333333342, 0.667028888888906, 0.639867272727285, 0.614267272727288, 0.583570000000007, 0.550549090909101,
0.518540000000008, 0.502667272727277, 0.493010000000002, 0.481458181818183, 0.476640000000002, 0.464140000000006,
0.442321818181823, 0.425340000000007, 0.402184444444453, 0.386473333333345, 0.364377500000003, 0.352828888888891,
0.335606666666681, 0.312140000000011, 0.293051111111114, 0.265140000000003, 0.251851111111115, 0.245920000000001,
0.243395555555557, 0.237860000000003, 0.231340000000001, 0.228460000000003, 0.218751111111117, 0.205840000000002,
0.194740000000006, 0.182995555555561, 0.168300000000005, 0.151240000000007, 0.134240000000010, 0.116160000000012,
0.105460000000002, 0.095890000000002, 0.095889999999998, 0.101051111111108, 0.100380000000001, 0.101779999999999,
0.098240000000002, 0.094120000000002, 0.096451111111110, 0.090000000000001, 0.087980000000001, 0.086400000000001,
0.083720000000000, 0.088239999999998, 0.090539999999999, 0.098139999999996, 0.104289999999999, 0.107509999999999,
0.108020000000001, 0.106540000000002, 0.102800000000000, 0.100640000000000, 0.099880000000002, 0.095440000000003,
0.089440000000000, 0.084590000000002, 0.072940000000004, 0.063850000000001, 0.059600000000001, 0.051760000000001,
0.047390000000000, 0.047239999999998, 0.047320000000001, 0.045699999999999, 0.049859999999997, 0.054219999999999,
0.052349090909091, 0.045400000000002, 0.038485454545454, 0.035703636363643, 0.023921818181818, 0.024739999999999,
0.023940000000000, 0.035667272727265, 0.032176363636366, 0.040819999999995, 0.048112727272723, 0.053439999999997,
0.053840000000000, 0.053351111111114, 0.044289999999999, 0.045551111111111, 0.043002500000001, 0.043951111111109,
0.042862222222224, 0.048530000000000, 0.048317777777778, 0.047559999999999, 0.046540000000004, 0.037895555555558,
0.036039999999998, 0.038200000000001, 0.034699999999998, 0.038539999999998, 0.038206666666667, 0.036949090909090,
0.035621818181822, 0.029770000000001, 0.026394545454547, 0.020820000000000, 0.019212727272730, 0.013810000000002,
0.010530909090910, 0.007440000000001, 0.007440000000000, 0.014258181818177, 0.013140000000000, 0.015819999999999,
0.018228888888891, 0.012206666666665, 0.013573333333334, 0.012062222222223, 0.013027499999999, 0.020328888888885,
0.026484444444441, 0.030739999999998, 0.035639999999998, 0.034540000000000, 0.037085454545452, 0.032750000000001,
0.030767272727273, 0.031603636363635, 0.027350000000004, 0.026739999999999, 0.028559999999999, 0.030330909090908,
0.026690000000006, 0.020577500000001, 0.018628888888889, 0.018162222222222, 0.013051111111112, 0.012064999999999,
0.012928888888890, 0.013651111111109, 0.011940000000002, 0.017162222222221, 0.019439999999999, 0.022639999999998,
0.021640000000001, 0.022680000000000, 0.022689999999998, 0.027284444444446, 0.023800000000002, 0.022319999999998,
0.025420000000003, 0.020495555555555, 0.020280000000000, 0.019373333333334, 0.015680000000002, 0.009680000000003,
0.002251111111115, -0.002210000000000, -0.004709999999999, -0.009637777777776, -0.009460000000002, -0.007793333333334,
-0.003210000000002, 0.002939999999997, 0.013209999999992, 0.015284444444445, 0.017879999999998, 0.004640000000007,
0.005619999999997, 0.005317777777778, 0.002620000000000, 0.010259999999994, 0.014829999999997, 0.021039999999997,
0.033539999999994, 0.025540000000003, 0.025740000000000, 0.019630000000001, 0.014850000000000, 0.012640000000003,
0.007380000000003, 0.004439999999999, 0.012640000000000, 0.013049999999998, 0.015909999999999, 0.015040000000001,
0.012679999999999, 0.013360000000000, 0.011917777777779, 0.006240000000002, 0.002090000000000, 0.002784444444444,
0.005239999999998, 0.008173333333333, 0.016289999999998, 0.026929999999994, 0.026328888888891, 0.025160000000000,
0.026819999999999, 0.022884444444448, 0.011000000000008, 0.011539999999999, 0.003940000000003, 0.004839999999999,
-0.000259999999998, 0.008169999999999, 0.008970000000001, 0.006119999999999, 0.010973333333329, 0.017419999999999,
0.026120000000000, 0.027039999999997, 0.029280000000002, 0.026370000000000, 0.025373333333334, 0.021960000000001,
0.018528888888891, 0.016040000000000, 0.008740000000003, -0.002404444444442, -0.003620000000002, -0.002060000000000,
0.003329999999998, 0.004520000000001, 0.012051111111105, 0.015459999999999, 0.010540000000003, 0.011106666666666,
0.014939999999998, 0.009580000000001, 0.008940000000000, 0.011439999999999, 0.009440000000001, 0.013659999999999,
0.016059999999999, 0.020062222222222, 0.020460000000003, 0.016739999999999, 0.021570000000001, 0.017630000000000,
0.016673333333333, 0.015020000000001, 0.012106666666666, 0.009640000000002, 0.002090000000006, -0.010326666666655,
-0.018379999999999, -0.020393333333333, -0.019150000000001, -0.011848888888894, -0.004040000000003, 0.002239999999998,
0.000303636363637, -0.003059999999999, -0.002450909090910, -0.005179999999999, -0.007514545454545, -0.008278181818182,
-0.005960000000001, -0.002596363636365, 0.002879999999995, 0.013673333333327, 0.022006666666666, 0.024452499999997,
0.030306666666664, 0.020840000000011, 0.009290000000002, 0.005240000000001, -0.001004444444444, -0.002626666666665,
-0.003010000000002, 0.002114999999997, 0.006349090909088, 0.009399999999998, 0.018130909090905, 0.023779999999999,
0.029503636363631, 0.034412727272726, 0.035100000000000, 0.032485454545457, 0.028180000000001, 0.024858181818188,
0.018706666666665, 0.017440000000003, 0.013639999999997, 0.011265000000006, 0.009428888888888, 0.010339999999999,
0.013777499999999, 0.014439999999999, 0.015290000000000, 0.015006666666667, 0.017717777777776, 0.017660000000000,
0.023751111111109, 0.024450000000000, 0.027839999999998, 0.026240000000001, 0.022819999999999, 0.024528888888888,
0.024560000000001, 0.020840000000002, 0.014880000000001, 0.006506666666669, 0.000280000000001, -0.000537777777779,
0.000690000000000, 0.006195555555552, 0.007120000000002, 0.010706666666661, 0.014380000000000, 0.013262222222223,
0.012120000000000, 0.012739999999999, 0.004380000000002, 0.005779999999999, 0.011239999999997, 0.022739999999995,
0.033569999999999, 0.039273333333333, 0.039859999999999, 0.041784444444443, 0.040170000000003, 0.027373333333337,
0.015080000000005, 0.008784444444443, 0.007540000000001, 0.006017777777777, 0.013639999999993, 0.022949999999994,
0.029562222222219, 0.042819999999993, 0.051084444444440, 0.045980000000004, 0.043640000000000, 0.041640000000001,
0.038570000000002, 0.031606666666667, 0.030780000000000, 0.029419999999998, 0.034095555555552, 0.040839999999994,
0.049239999999998, 0.053919999999999, 0.058462222222217, 0.066389999999995, 0.067706666666668, 0.067499999999999,
0.063960000000003, 0.061573333333333, 0.054420000000002, 0.055751111111109, 0.056603636363637, 0.059303636363634,
0.064299999999998, 0.070303636363634, 0.073240000000000, 0.073630909090908, 0.072049090909091, 0.065220000000002,
0.057985454545455, 0.055894545454546, 0.052706666666671, 0.039728888888889, 0.040190000000000, 0.037940000000003,
0.032806666666667, 0.034564999999999, 0.038339999999998, 0.037477500000001, 0.036040000000001, 0.032084444444446,
0.028690000000001, 0.027128888888890, 0.025500000000001, 0.022040000000002, 0.017000000000002, 0.012840000000002,
0.011280000000000, 0.014259999999999, 0.020773333333330, 0.027039999999997, 0.031803636363633, 0.036429999999999,
0.034467272727274, 0.030320000000002, 0.032003636363633, 0.031049090909093, 0.023300000000004, 0.016067272727275,
0.010250000000005, 0.002603636363639, -0.004499999999999, -0.005460000000001, -0.004119999999999, -0.002960000000005,
0.005309999999999, 0.008409999999996, 0.014099999999996, 0.018219999999999, 0.019550000000000, 0.020373333333333,
0.017920000000004, 0.010128888888891, 0.006614999999999, 0.002484444444447, 0.001862222222221, -0.000959999999999,
0.004040000000002, 0.000806666666668, 0.001762222222219, 0.005414999999999, -0.002509999999997, -0.005070000000001,
-0.010509999999994, -0.014040000000000, -0.013410000000001, -0.012470000000000, -0.013193333333333, -0.006420000000003,
-0.002500000000001, 0.004759999999996, 0.002149090909094, 0.005089999999998, 0.010603636363634, 0.012749090909091,
0.016794545454544, 0.021540000000000, 0.019758181818183, 0.015930909090909, 0.011980000000005, 0.002840000000000,
-0.001659999999998, -0.005950000000001, -0.004170000000002, 0.002510000000003, -0.000360000000003, 0.008779999999997,
0.014519999999997, 0.019773333333333, 0.020290000000001, 0.015430000000002, 0.012039999999999, 0.010177500000007,
-0.001982222222218, -0.014159999999994, -0.014060000000004, -0.025959999999994, -0.021772500000000, -0.019360000000003,
-0.014315555555556, -0.010760000000005, -0.004110000000002, 0.001106666666665, 0.008839999999996, 0.002860000000003,
0.004939999999998, 0.004450000000000, 0.008540000000000, 0.008440000000000, 0.001640000000003, -0.012199999999999,
-0.015204444444445, -0.013700000000001, -0.008437777777780, -0.003750000000002, 0.001959999999997, 0.007206666666671,
0.003060000000000, 0.006317777777773, 0.009540000000001, 0.004940000000001, -0.001493333333332, -0.009399999999996,
-0.013280000000000, -0.013426666666667, -0.000720000000004, 0.006979999999998, 0.009759999999998, 0.009762222222222,
0.009859999999999, 0.008580000000001, 0.007528888888889, 0.006810000000000, 0.003410000000001, -0.003259999999997,
-0.009159999999998, -0.010820000000000, -0.009804444444446, -0.004560000000000, -0.003715555555556, 0.000079999999998,
0.002369999999999, 0.007006666666663, 0.016419999999998, 0.018300000000000, 0.015340000000001, 0.011790000000001,
0.007590000000001, 0.002090000000003, -0.003871111111109, -0.005440000000001, -0.008159999999998, -0.014026666666666,
-0.017159999999999, -0.015240000000001, -0.012371111111112, -0.016899999999997, -0.016640000000001, -0.013415555555556,
-0.012070000000001, -0.012410000000000, -0.009460000000003, -0.004460000000002, -0.009359999999998, 0.000039999999995,
0.001139999999999, -0.000260000000000, 0.000720000000004, -0.006080000000000, -0.009050000000000, -0.009800000000000,
-0.009120000000001, -0.008439999999996, -0.013590000000000, -0.012970000000000, -0.012800000000002, -0.010490000000000,
-0.010750000000000, -0.009740000000003, -0.001182222222224, 0.001180000000000, 0.003319999999996, 0.009520000000000,
0.010319999999997, 0.014780000000000, 0.009840000000010, -0.002059999999994, -0.012800000000000, -0.014219999999996,
-0.020940000000000, -0.021400000000000, -0.021280000000002, -0.016760000000001, -0.008200000000006, 0.000019999999994,
0.011599999999999, 0.012360000000003, 0.007128888888891, 0.001450000000001, -0.005649999999999, -0.010699999999999,
-0.017319999999996, -0.022530000000000, -0.023780000000001, -0.020793333333336, -0.014340000000002, -0.005680000000003,
0.003479999999994, 0.014760000000000, 0.020506666666665, 0.016340000000002, 0.008240000000002, 0.000740000000006,
-0.007259999999999, -0.006137777777781, -0.003780000000000, -0.000980000000000, 0.002719999999998, 0.006879999999997,
0.004506666666671, 0.000560000000001, 0.002219999999999, 0.001490000000001, 0.000880000000000, -0.000693333333333,
-0.001959999999999, -0.003439999999999, -0.013279999999995, -0.020815555555552, -0.022000000000000, -0.020710000000001,
-0.017410000000002, -0.016880000000000, -0.009160000000004, -0.006360000000001, -0.006260000000000, -0.006060000000001,
-0.007560000000000, -0.008460000000000, -0.018730000000000, -0.018959999999999, -0.023214545454547, -0.020760000000001,
-0.014214545454547, -0.007587272727276, -0.003460000000001, 0.004221818181815, 0.000221818181821, -0.003860000000000,
-0.004496363636363, -0.005405454545455, -0.002820000000004, 0.000217777777780, 0.002939999999998, 0.002595555555557,
-0.001204444444444, -0.006771111111110, -0.011148888888889, -0.012959999999999, -0.013010000000002, -0.009926666666668,
-0.011259999999999, -0.007120000000002, -0.003404444444445, -0.001680000000000, -0.003439999999999, -0.004048888888889,
0.002329999999998, 0.007989999999996, 0.015540000000000, 0.019839999999998, 0.018658181818182, 0.011340000000001,
0.002930909090913, -0.006832727272726, -0.012023636363636, -0.015779999999998, -0.018769090909091, -0.018132727272730,
-0.015980000000000, -0.016696363636363, -0.016150000000005, -0.009993333333335, -0.003110000000005, 0.005773333333328,
0.011039999999999, 0.014773333333331, 0.012040000000001, 0.010817777777779, 0.007873333333333, 0.005028888888891,
0.000840000000000, -0.003209999999997, -0.006060000000000, -0.003826666666670, -0.004339999999999, -0.004400000000001,
-0.009559999999996, -0.017639999999998, -0.018860000000001, -0.023126666666662, -0.020930000000002, -0.009550000000009,
-0.005420000000000, -0.004590000000001, -0.004260000000000, -0.004415555555556, -0.001980000000001, 0.002719999999998,
0.005180000000000, 0.004500000000001, 0.005839999999999, 0.002684444444447, 0.004579999999998, 0.004300000000000,
0.008289999999999, 0.004150000000003, -0.004549999999998, -0.005370000000000, -0.002210000000001, -0.002310000000000,
0.002439999999997, 0.005439999999998, 0.000740000000002, 0.003739999999999, 0.006840000000000, 0.011939999999995,
0.003740000000003, 0.000819999999997, 0.004460000000004, -0.001300000000001, 0.001570000000001, -0.002649999999994,
-0.010310000000001, -0.007539999999998, -0.011359999999999, -0.013520000000002, -0.009240000000001, -0.009880000000000,
-0.014040000000001, -0.013959999999997, -0.017582222222223, -0.011900000000004, -0.008050000000000, -0.007530000000000,
-0.007393333333334, -0.004260000000002, 0.004119999999995, 0.011939999999998, 0.013695555555556, 0.011540000000001,
0.007940000000001, 0.005589999999999, 0.002590000000005, -0.003359999999999, -0.008715555555554, -0.011280000000000,
-0.003200000000000, 0.003439999999998, 0.008499999999997, 0.013439999999998, 0.0, 0.0,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
0.0, 0.0, 0.0, 0.0}; // generated with MATLAB with newdata(1051:2050) at AverageAC line: 70
    int i;
    for(i=0; i<1000; i++)
    {
        expected_npda_avg[i] = expected_npda_avg[i] * 10000.0 - 0.4; //-0.4 is the correction due to median
    }

    iret = npda_scan((fptype*) cal_data, (word*)&scanData.Scans[0].Data[0], scan_count, &valid_scan_cnt, &npda_avg_len, scan_med, offsets);

  	TEST_ASSERT_EQUAL_UINT(0,iret);
  	TEST_ASSERT_EQUAL_UINT(1,valid_scan_cnt);
  	TEST_ASSERT_EQUAL_UINT(952,npda_avg_len);
    
    for(i=0; i<1000; i++)
    {
      	TEST_ASSERT_FLOAT_WITHIN(1.0, expected_npda_avg[i], __npda_avg[i]);
    }
    
    scan_count = 1;
    scan_med =  20195; //In MATLAB it is 20195, therefore no correction required compared to MATLAB
    
    fptype expected_npda_avg2[] = {0.041570000000000, 0.045635000000002, 0.047138181818183, 0.044265454545456, 0.041447272727274, 0.038559999999999,
0.035647272727274, 0.038742727272729, 0.042288181818183, 0.040270000000000, 0.037270000000001, 0.037770000000001,
0.035979090909092, 0.033258888888889, 0.029970000000001, 0.028032500000001, 0.031520000000000, 0.032897777777779,
0.034897777777779, 0.038420000000002, 0.042308888888890, 0.049420000000001, 0.050270000000001, 0.050670000000001,
0.047370000000001, 0.043570000000000, 0.040570000000001, 0.037445000000000, 0.033010000000002, 0.028035000000002,
0.033295000000002, 0.039386666666668, 0.044980000000001, 0.054310000000004, 0.061780000000001, 0.063470000000001,
0.070690000000001, 0.066014444444444, 0.063340000000001, 0.062280000000000, 0.059100000000001, 0.057820000000001,
0.059555000000001, 0.059753333333334, 0.061100000000001, 0.064040000000003, 0.068170000000002, 0.072980000000001,
0.076230000000001, 0.077260000000002, 0.079253333333334, 0.080715454545456, 0.081990000000001, 0.082642727272729,
0.084792727272728, 0.085170000000001, 0.083388181818183, 0.081610909090910, 0.081020000000001, 0.079201818181819,
0.085949999999999, 0.087374545454547, 0.083047272727272, 0.079347777777779, 0.078592222222223, 0.083570000000001,
0.083576250000000, 0.082770000000002, 0.087636666666667, 0.092442222222225, 0.098086666666669, 0.100213750000001,
0.099492727272728, 0.098229090909091, 0.096960909090910, 0.097288181818183, 0.098520000000001, 0.098320000000000,
0.100201818181821, 0.106706363636365, 0.111470000000001, 0.113675000000001, 0.116639999999999, 0.110870000000001,
0.113058888888890, 0.113901250000003, 0.117786666666667, 0.122120000000002, 0.125108888888890, 0.128370000000003,
0.132614444444446, 0.135181111111112, 0.137935000000001, 0.140900000000002, 0.143900000000000, 0.143120000000001,
0.146480000000001, 0.150770000000002, 0.154740000000003, 0.158150000000001, 0.160636666666667, 0.169795000000003,
0.176824545454547, 0.178897272727273, 0.175842727272727, 0.168930000000001, 0.167433636363635, 0.160924545454545,
0.155970000000001, 0.148869999999998, 0.143642727272727, 0.144674545454546, 0.148980000000001, 0.160103333333337,
0.174320000000006, 0.186197777777780, 0.192520000000001, 0.196953333333338, 0.202342222222223, 0.205653333333336,
0.210914444444445, 0.218192222222221, 0.232065000000004, 0.243829090909092, 0.258010909090912, 0.269435000000000,
0.279260909090913, 0.285651818181820, 0.294765454545457, 0.305960000000001, 0.310906363636365, 0.313910909090911,
0.319531111111112, 0.325636666666667, 0.328381111111113, 0.334353333333335, 0.341386666666668, 0.346025555555556,
0.350825555555558, 0.353470000000001, 0.356936666666667, 0.356650000000001, 0.361436666666671, 0.366235000000000,
0.364405000000001, 0.364240000000002, 0.359800000000000, 0.354569999999999, 0.346030000000001, 0.340500000000001,
0.334199999999997, 0.327349999999999, 0.322540000000001, 0.319580000000001, 0.315319999999999, 0.311180000000000,
0.310000000000001, 0.311990000000001, 0.312450000000001, 0.312490000000001, 0.315090000000001, 0.324820000000001,
0.340520000000006, 0.361020000000009, 0.394530000000001, 0.425700000000001, 0.455660000000018, 0.495630000000012,
0.538370000000001, 0.583270000000001, 0.622670000000015, 0.675050000000023, 0.756250000000001, 0.835410000000001,
0.921560000000001, 1.022309999999982, 1.125549999999956, 1.226559999999956, 1.332269999999951, 1.451509999999978,
1.577339999999948, 1.687879999999957, 1.795797777777713, 1.945844999999961, 2.100044999999972, 2.228069999999945,
2.346144999999928, 2.467519999999972, 2.589119999999976, 2.700344999999951, 2.801244999999941, 2.894744999999980,
2.988169999999981, 3.072269999999965, 3.145944999999955, 3.210719999999987, 3.266669999999989, 3.305694999999989,
3.329544999999988, 3.345203333333330, 3.346140000000003, 3.335580000000007, 3.316340000000011, 3.284750000000010,
3.235660000000026, 3.174586666666706, 3.111005000000043, 3.033310000000020, 2.951050000000019, 2.869636666666699,
2.791010000000035, 2.697260000000036, 2.603800000000042, 2.504920000000045, 2.398700000000049, 2.248370000000033,
2.116440000000029, 2.042010000000016, 1.935765000000070, 1.831030000000024, 1.729180000000024, 1.623920000000048,
1.557010909090953, 1.446775000000026, 1.359833636363671, 1.296342727272764, 1.230205000000047, 1.157665454545482,
1.085040000000033, 1.029456363636390, 0.984295000000031, 0.933792727272771, 0.880260000000023, 0.833581111111134,
0.778664444444483, 0.742853333333342, 0.710731111111128, 0.678220000000014, 0.649036666666681, 0.625781111111126,
0.598303333333341, 0.573870000000014, 0.551438181818194, 0.531320000000012, 0.510295000000005, 0.488079090909098,
0.467550000000007, 0.454088181818188, 0.443230000000003, 0.432883636363640, 0.423020000000005, 0.407120000000008,
0.390574545454550, 0.374070000000008, 0.353581111111117, 0.344436666666674, 0.329307500000005, 0.318703333333335,
0.306470000000012, 0.289803333333342, 0.276347777777781, 0.256935000000004, 0.243658888888898, 0.232060000000005,
0.223942222222227, 0.213925000000004, 0.205853333333337, 0.199820000000005, 0.191792222222226, 0.183045000000002,
0.176620000000003, 0.170970000000004, 0.163830000000003, 0.152600000000007, 0.141586666666673, 0.127955000000011,
0.118210000000003, 0.109125000000003, 0.104035000000003, 0.102458888888890, 0.100870000000002, 0.098520000000002,
0.097940000000001, 0.095440000000002, 0.100464444444444, 0.102835000000000, 0.110849999999995, 0.112935000000000,
0.110685000000001, 0.111320000000000, 0.113470000000000, 0.111970000000001, 0.117500000000000, 0.120220000000002,
0.118244999999999, 0.120508888888891, 0.117930000000001, 0.114300000000001, 0.113520000000002, 0.110360000000004,
0.104753333333334, 0.100095000000002, 0.095965000000002, 0.093420000000000, 0.092435000000001, 0.087535000000002,
0.083205000000001, 0.082386666666668, 0.079780000000002, 0.078090000000000, 0.081549999999999, 0.084190000000001,
0.082888181818183, 0.078885000000003, 0.070815454545456, 0.065770000000006, 0.056338181818183, 0.056520000000001,
0.049720000000004, 0.053583636363635, 0.050001818181821, 0.051200000000000, 0.055465454545452, 0.055960000000002,
0.055070000000001, 0.053847777777781, 0.048207500000000, 0.047908888888891, 0.043863750000002, 0.043136666666667,
0.043825555555556, 0.043120000000002, 0.041086666666668, 0.039530000000000, 0.040340000000002, 0.037964444444447,
0.037394999999999, 0.041270000000001, 0.041475000000000, 0.044136666666665, 0.046492222222223, 0.047838181818182,
0.047765454545458, 0.042755000000003, 0.038620000000002, 0.033460000000002, 0.029292727272731, 0.023985000000003,
0.021542727272729, 0.018270000000002, 0.018870000000001, 0.017415454545456, 0.016235000000001, 0.016390000000001,
0.022414444444447, 0.017403333333333, 0.018953333333336, 0.018642222222222, 0.019670000000001, 0.024497777777776,
0.027875555555555, 0.030070000000000, 0.032120000000000, 0.031520000000001, 0.033383636363636, 0.032580000000001,
0.032715454545455, 0.035606363636362, 0.029670000000008, 0.028006363636364, 0.026760000000002, 0.025474545454546,
0.022195000000005, 0.017495000000002, 0.021764444444442, 0.021620000000002, 0.025108888888890, 0.025219999999999,
0.024620000000006, 0.019814444444446, 0.016982500000003, 0.017631111111112, 0.017670000000001, 0.017920000000001,
0.015920000000002, 0.018110000000001, 0.016680000000001, 0.016803333333334, 0.016670000000002, 0.015610000000000,
0.016480000000004, 0.011464444444445, 0.012225000000000, 0.012686666666667, 0.012160000000001, 0.011430000000001,
0.008208888888893, 0.006095000000000, 0.006020000000001, 0.003670000000002, 0.003080000000001, 0.004820000000000,
0.009714999999999, 0.012660000000000, 0.017544999999997, 0.017553333333335, 0.016140000000001, 0.005840000000006,
0.001080000000002, -0.002724444444443, -0.008574999999998, -0.004500000000002, -0.003350000000000, 0.003119999999998,
0.007669999999999, 0.012569999999999, 0.015320000000000, 0.018160000000002, 0.014860000000001, 0.014120000000002,
0.012070000000002, 0.011450000000000, 0.016303333333334, 0.017580000000000, 0.020324999999999, 0.019786666666670,
0.013800000000002, 0.009940000000004, 0.004508888888892, -0.001504999999997, -0.004005000000000, -0.000880000000001,
0.000130000000001, 0.003070000000000, 0.008939999999999, 0.013429999999999, 0.017253333333332, 0.020300000000000,
0.020350000000001, 0.014531111111116, 0.006530000000006, 0.003200000000001, -0.002229999999997, -0.000080000000000,
0.000120000000001, 0.008565000000001, 0.009490000000002, 0.006540000000000, 0.010920000000000, 0.013230000000000,
0.017710000000001, 0.017758888888890, 0.017100000000001, 0.016080000000001, 0.014186666666668, 0.011520000000002,
0.009536666666669, 0.008595000000000, 0.004670000000003, -0.000535555555554, -0.001409999999999, -0.001829999999999,
0.000665000000000, 0.003185000000000, 0.007853333333331, 0.011100000000000, 0.010540000000001, 0.011425555555556,
0.012200000000001, 0.008580000000002, 0.005920000000002, 0.008920000000000, 0.007770000000001, 0.012495000000000,
0.016260000000001, 0.015686666666668, 0.014430000000003, 0.010270000000001, 0.008295000000002, 0.003715000000003,
-0.001046666666664, -0.003799999999999, -0.005946666666665, -0.008679999999998, -0.010529999999998, -0.011424444444443,
-0.012349999999999, -0.008630000000001, -0.003535000000001, 0.005742222222218, 0.010739999999999, 0.014486666666666,
0.009101818181822, 0.004780000000002, 0.004020000000001, 0.003075000000001, 0.003020000000001, 0.004365454545454,
0.007820000000000, 0.011070000000000, 0.015909999999996, 0.025003333333329, 0.032103333333333, 0.036282499999999,
0.040553333333332, 0.034753333333341, 0.026101250000002, 0.020570000000003, 0.012503333333336, 0.008986666666670,
0.005620000000002, 0.005745000000000, 0.009829090909089, 0.013319999999999, 0.017719999999999, 0.021160000000000,
0.023510909090909, 0.025465454545454, 0.024800000000003, 0.022642727272728, 0.023450000000000, 0.022201818181824,
0.017797777777777, 0.018103333333337, 0.012914444444444, 0.013532500000002, 0.013392222222223, 0.012920000000001,
0.013920000000000, 0.015653333333331, 0.018445000000001, 0.016936666666668, 0.018192222222222, 0.016650000000002,
0.016875555555556, 0.018230000000000, 0.018070000000001, 0.020020000000000, 0.017950000000001, 0.019675555555555,
0.024420000000000, 0.025375555555557, 0.022825000000002, 0.016853333333336, 0.012680000000001, 0.012670000000000,
0.014545000000000, 0.016864444444445, 0.015740000000002, 0.015586666666666, 0.015755000000001, 0.013636666666669,
0.012190000000001, 0.010725555555557, 0.008815000000001, 0.005200000000002, 0.007370000000000, 0.015519999999997,
0.023610000000000, 0.027392222222222, 0.030259999999999, 0.032720000000002, 0.031445000000001, 0.028436666666670,
0.021750000000003, 0.018836666666668, 0.018970000000001, 0.020520000000000, 0.023586666666665, 0.024265000000001,
0.023408888888890, 0.027059999999999, 0.027220000000001, 0.023745000000003, 0.018220000000001, 0.014820000000002,
0.015010000000001, 0.013442222222221, 0.016970000000000, 0.021889999999999, 0.026314444444445, 0.028084999999996,
0.032786666666667, 0.033680000000000, 0.035203333333333, 0.036195000000000, 0.036797777777778, 0.035820000000002,
0.032860000000002, 0.032320000000000, 0.025980000000003, 0.028981111111109, 0.029906363636365, 0.034329090909088,
0.038250000000000, 0.042042727272727, 0.043720000000002, 0.042556363636365, 0.039465454545456, 0.034190000000001,
0.031697272727275, 0.028506363636365, 0.025531111111114, 0.018797777777778, 0.019763750000001, 0.020475555555555,
0.022120000000001, 0.025395000000000, 0.029219999999999, 0.025582500000003, 0.022803333333334, 0.017836666666671,
0.012470000000001, 0.011047777777780, 0.009020000000002, 0.006580000000002, 0.003350000000002, 0.002503333333334,
0.005114999999999, 0.011299999999999, 0.017369999999999, 0.024069999999998, 0.023651818181820, 0.023075000000001,
0.022324545454547, 0.018150000000004, 0.016815454545454, 0.016065454545456, 0.011700000000003, 0.007620000000001,
0.006165000000002, 0.005915454545455, 0.008420000000000, 0.011210000000001, 0.011330000000003, 0.009958888888887,
0.014030000000001, 0.014659999999999, 0.016905000000000, 0.018425000000000, 0.019430000000002, 0.015286666666671,
0.008140000000006, 0.001408888888891, 0.000207500000000, -0.002413333333331, -0.001057777777779, -0.000929999999999,
0.003658888888890, 0.004903333333332, 0.009781111111109, 0.012701250000001, 0.009360000000002, 0.006275000000002,
-0.000869999999993, -0.003489999999999, -0.003219999999999, -0.003339999999999, -0.004168888888888, -0.001060000000001,
0.003169999999999, 0.007099999999999, 0.007906363636364, 0.011350000000000, 0.013392727272728, 0.014538181818182,
0.014106363636365, 0.014149999999999, 0.015983636363637, 0.014151818181820, 0.008880000000004, 0.001711666666668,
-0.004329999999996, -0.009729999999998, -0.010260000000001, -0.002690000000000, -0.000057777777779, 0.008509999999998,
0.013690000000000, 0.016803333333334, 0.020980000000001, 0.018525000000001, 0.017310000000001, 0.013832500000008,
0.004742222222226, -0.004379999999993, -0.005911250000001, -0.011629999999996, -0.003411249999999, -0.003513333333332,
-0.004357777777777, -0.002080000000003, 0.004154999999999, 0.008297777777777, 0.013599999999998, 0.010610000000003,
0.010414444444445, 0.009530000000001, 0.014620000000001, 0.010120000000003, 0.005670000000003, -0.004124999999998,
-0.008368888888890, -0.006559999999999, -0.004468888888891, 0.001230000000000, 0.003259999999999, 0.007003333333336,
0.005970000000000, 0.008175555555554, 0.010870000000000, 0.009320000000002, 0.005742222222224, 0.000170000000004,
-0.004919999999999, -0.004113333333335, 0.001779999999999, 0.005709999999999, 0.006660000000001, 0.005242222222223,
0.005780000000000, 0.006620000000000, 0.005347777777779, 0.004315000000001, 0.001070000000002, -0.003229999999997,
-0.011629999999996, -0.006805000000000, -0.004291111111111, 0.000459999999999, 0.005186666666667, 0.010105000000000,
0.010780000000000, 0.012836666666666, 0.015570000000000, 0.015220000000001, 0.012931111111113, 0.011445000000001,
0.007270000000003, 0.001595000000003, -0.003724444444441, -0.006619999999999, -0.006969999999999, -0.009229999999999,
-0.011384999999998, -0.010270000000000, -0.009346666666666, -0.010959999999998, -0.010140000000000, -0.002985555555557,
-0.002399999999999, 0.002115000000000, 0.006919999999996, 0.007370000000001, 0.002370000000003, 0.003720000000000,
0.003170000000001, 0.001220000000002, 0.002200000000005, -0.003634999999999, -0.005944999999999, -0.006499999999998,
-0.010344999999999, -0.011284999999997, -0.014539999999999, -0.014775000000000, -0.011785000000001, -0.009539999999999,
-0.008985000000000, -0.006385000000001, 0.001358888888889, 0.003069999999999, 0.005890000000000, 0.007730000000000,
0.008540000000001, 0.008860000000001, 0.005790000000008, -0.002479999999995, -0.009230000000000, -0.008399999999999,
-0.009479999999998, -0.011339999999999, -0.012639999999999, -0.012480000000000, -0.006580000000004, 0.000079999999996,
0.009260000000001, 0.009300000000002, 0.006275555555558, 0.001440000000002, -0.004124999999997, -0.009364999999999,
-0.010999999999999, -0.011689999999999, -0.010315000000001, -0.005563333333335, -0.001110000000000, 0.004319999999998,
0.010399999999998, 0.016020000000001, 0.018381111111112, 0.014220000000002, 0.007420000000004, -0.000804999999993,
-0.007779999999998, -0.007613333333334, -0.007199999999998, -0.006279999999999, -0.003370000000001, -0.000940000000000,
-0.001979999999997, -0.003909999999998, -0.004679999999999, -0.005494999999999, -0.005290000000000, -0.010407777777777,
-0.013489999999998, -0.014079999999999, -0.016369999999998, -0.016307777777777, -0.012630000000000, -0.007820000000000,
-0.003280000000002, -0.003414999999999, 0.001119999999999, -0.000379999999998, -0.000529999999999, -0.004079999999998,
-0.009279999999999, -0.011229999999998, -0.016650000000000, -0.014884999999999, -0.017234545454547, -0.013280000000001,
-0.004461818181819, -0.000470909090910, 0.000820000000001, -0.000084545454544, -0.006302727272723, -0.008669999999999,
-0.007539090909091, -0.007811818181817, -0.006850000000001, -0.004046666666666, -0.001755000000000, 0.000725555555556,
0.000981111111112, -0.001624444444442, -0.008757777777773, -0.016029999999998, -0.019080000000000, -0.018230000000000,
-0.017504999999999, -0.011400000000001, -0.007246666666667, -0.007419999999999, -0.004820000000001, -0.003685555555555,
0.004424999999999, 0.010314999999997, 0.012370000000001, 0.013570000000000, 0.009751818181820, 0.000910000000003,
-0.006698181818177, -0.010870909090908, -0.013279999999998, -0.014469999999999, -0.013257272727272, -0.011530000000000,
-0.011689999999998, -0.012902727272726, -0.012070000000001, -0.007713333333335, -0.001580000000001, 0.001620000000000,
0.004758888888889, 0.007381111111110, 0.007020000000001, 0.009942222222226, 0.005603333333335, 0.002925555555558,
-0.000429999999999, -0.000754999999999, 0.000195000000001, 0.001781111111111, 0.001390000000002, -0.001219999999998,
-0.006649999999996, -0.013089999999998, -0.014390000000000, -0.015096666666664, -0.015304999999999, -0.011055000000003,
-0.009434999999999, -0.006680000000001, -0.004290000000000, -0.005063333333332, -0.004110000000000, -0.001420000000000,
-0.002629999999999, -0.004679999999998, -0.001880000000001, -0.003524444444442, -0.002165000000001, -0.003059999999999,
0.000690000000000, -0.000364999999998, -0.005884999999998, -0.005490000000000, -0.000385000000000, -0.001449999999998,
0.001419999999999, -0.000629999999998, -0.000879999999999, 0.001620000000000, 0.006620000000001, 0.006520000000001,
0.002020000000003, -0.000990000000000, -0.000219999999996, -0.004270000000000, -0.000930000000000, -0.000179999999998,
-0.001499999999999, -0.001664999999996, -0.005552222222221, -0.005109999999999, -0.004519999999998, -0.006439999999999,
-0.009389999999999, -0.010049999999997, -0.014463333333332, -0.016259999999998, -0.016905000000000, -0.015294999999999,
-0.013696666666670, -0.006970000000000, -0.000880000000003, 0.006499999999998, 0.011220000000001, 0.011195000000002,
0.009770000000001, 0.008945000000001, 0.005195000000006, -0.000954999999998, -0.005002222222220, -0.008629999999997,
-0.006439999999999, -0.003290000000000, 0.000079999999999, 0.013439999999998, 0.0, 0.0,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
0.0, 0.0, 0.0, 0.0, 0.0, 0.0,
0.0, 0.0, 0.0, 0.0};

    for(i=0; i<1000; i++)
    {
        expected_npda_avg2[i] = expected_npda_avg2[i] * 10000.0;
    }

    iret = npda_scan((fptype*) cal_data, (word*)&scanData.Scans[1].Data[0], scan_count, &valid_scan_cnt, &npda_avg_len, scan_med, offsets+1);

  	TEST_ASSERT_EQUAL_UINT(0,iret);
  	TEST_ASSERT_EQUAL_UINT(2,valid_scan_cnt);
  	TEST_ASSERT_EQUAL_UINT(951,npda_avg_len);
    
    for(i=0; i<1000; i++)
    {
      	TEST_ASSERT_FLOAT_WITHIN(1.0, expected_npda_avg2[i], __npda_avg[i]);
    }
    
}

/* ************************************************************************** */
/** 
 * @brief            npda_scan()
 *
 * @test             This is to test whether the npda_scan()
 *                   function returns error when offset is too high.
 * 
 * @note             None.
 */
/* ************************************************************************** */
void test_npda_scan_offset_too_high()
{
    int iret;
    int scan_count = 0;
    uint16_t npda_avg_len = 0;
    unsigned int valid_scan_cnt = 0;
    word scan_med =  20193; 
    word offset = PDAB_SCAN_LENGTH_16 - MAX_WINDOW_SIZE + 1;

    iret = npda_scan((fptype*) cal_data, (word*)&scanData.Scans[0].Data[0], scan_count, &valid_scan_cnt, &npda_avg_len, scan_med, &offset);

  	TEST_ASSERT_EQUAL_UINT(101, iret);
    
}

/* ************************************************************************** */
/** 
 * @brief            npda_scan()
 *
 * @test             This is to test whether the npda_scan()
 *                   function returns error when transform to uniform
 *                   distribution fails.
 * 
 * @note             None.
 */
/* ************************************************************************** */
void test_npda_scan_transform_fails()
{
    int iret;
    int scan_count = 0;
    uint16_t npda_avg_len = 0;
    unsigned int valid_scan_cnt = 0;
    word scan_med =  20193; 
    word offset = 0;
    fptype data[] = {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0};

    iret = npda_scan(data, (word*)&scanData.Scans[0].Data[0], scan_count, &valid_scan_cnt, &npda_avg_len, scan_med, &offset);

  	TEST_ASSERT_EQUAL_UINT(202, iret);
    
}

/* ************************************************************************** */
/** 
 * @brief            npda_scan()
 *
 * @test             This is to test whether the npda_scan()
 *                   function returns error when interpolation fails.
 * 
 * @note             None.
 */
/* ************************************************************************** */
void test_npda_scan_interpolation_fails()
{
    int iret;
    int scan_count = 0;
    uint16_t npda_avg_len = 0;
    unsigned int valid_scan_cnt = 0;
    word scan_med =  20193; 
    word offset = 0;
    fptype data[] = {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 5.0};

    iret = npda_scan(data, (word*)data, scan_count, &valid_scan_cnt, &npda_avg_len, scan_med, &offset);

  	TEST_ASSERT_EQUAL_UINT(303, iret);
    
}

/* ************************************************************************** */
/** 
 * @brief            npda_scan()
 *
 * @test             This is to test whether the npda_scan()
 *                   function returns error when average calculation fails.
 * 
 * @note             None.
 */
/* ************************************************************************** */
void test_npda_scan_avg_calculation_fails()
{
    int iret;
    int scan_count = 0;
    uint16_t npda_avg_len = 0;
    unsigned int valid_scan_cnt = 0;
    word scan_med =  20193; 
    word offset = 0;
    fptype data[] = {0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 
            0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 0.0, 5.0};

    iret = npda_scan((fptype*) cal_data, (word*)data, scan_count, &valid_scan_cnt, &npda_avg_len, scan_med, &offset);

  	TEST_ASSERT_EQUAL_UINT(401, iret);
    
}

/* ************************************************************************** */
/** 
 * @brief            npda_block_end()
 *
 * @test             This is to test whether the npda_block_end()
 *                   function returns correct values when presented with sample
 *                   scan data for the whole block.
 * 
 * @note             None.
 */
/* ************************************************************************** */
void test_npda_block_end_correct_data()
{
    int iret;
    unsigned int valid_scans = 1;
    uint16_t npda_avg_len = 1000;
    unsigned int block_cnt = 0;

    fptype npda_avg[] = {0.042892140170877, 0.045044869127107, 0.047823178891416, 0.047064734446971, 0.047050345558083, 0.047188204143941,
0.048166040844278, 0.048800020642258, 0.050603616601854, 0.051585005490743, 0.053586047578285, 0.054622121652359,
0.054167448251685, 0.052332591349328, 0.050827239497476, 0.049596582931820, 0.048167795053031, 0.044856067780305,
0.044020970137207, 0.043907645221382, 0.045189874177612, 0.048358894379632, 0.050226821989059, 0.053295357342595,
0.055544377544615, 0.056372296736534, 0.056437273167510, 0.055323547578284, 0.052845737813975, 0.050849894379632,
0.050525448251686, 0.050745677207915, 0.052969609867847, 0.054660471820710, 0.058287593032830, 0.061228586298824,
0.064606623335861, 0.065293360709598, 0.066189986972224, 0.066476263066499, 0.065313055995793, 0.066216909531147,
0.067400364076601, 0.067133185625422, 0.066001603133840, 0.066632678891416, 0.067262081248319, 0.069897017275255,
0.072392030743269, 0.074766404480642, 0.077932840507577, 0.082476488655727, 0.086633609867847, 0.089949327039565,
0.093290653638891, 0.094483306837544, 0.093824347241584, 0.093317998756736, 0.091724589665826, 0.091251246231484,
0.093325744547982, 0.094306350608588, 0.092816498756735, 0.093815670473908, 0.094489353975591, 0.094238081248318,
0.094213126702864, 0.095282922999160, 0.096489960036197, 0.097458343874581, 0.097993756332494, 0.098442581248319,
0.099489946568184, 0.100502027376264, 0.100448892696130, 0.100540694042932, 0.102254296736534, 0.102007717611954,
0.101756013908251, 0.103441764750002, 0.105880458352696, 0.109280566096803, 0.112945367443605, 0.117716128386366,
0.121948343874581, 0.125760396063134, 0.130209973504211, 0.134380997073234, 0.137092862393100, 0.138303885962124,
0.142417098083336, 0.146229057679295, 0.149078202460441, 0.152192495389733, 0.154010296736534, 0.1565298253560632,
0.158667643537881, 0.162852209194447, 0.167059724345962, 0.170340741180978, 0.171007710877948, 0.173238986972225,
0.175324919632157, 0.175966694042931, 0.175079077881315, 0.173898619968857, 0.173295374177611, 0.170854855659093,
0.170225677207915, 0.170762465086702, 0.171969374177611, 0.173862626702863, 0.176062997073234, 0.179777071147309,
0.186253434783672, 0.192895333773571, 0.197591050945288, 0.201716061046298, 0.205690444884682, 0.210849333773571,
0.216943630069868, 0.223850296736534, 0.233455333773571, 0.241923434783672, 0.250181084615323, 0.258579037477275,
0.269037677207913, 0.278495057679294, 0.287965690675926, 0.297042667106903, 0.305834848925085, 0.314485454985691,
0.323971481921717, 0.334018815255051, 0.344974148588383, 0.356389111551347, 0.365504222662459, 0.372936296736533,
0.380475852292088, 0.387951778218013, 0.394809407847645, 0.400168963403199, 0.404450222662459, 0.406833555995793,
0.409602667106903, 0.412336000440237, 0.412976667106904, 0.413503333773570, 0.412723481921718, 0.411077111551348,
0.407720667106904, 0.404005481921719, 0.400178000440238, 0.396463185625423, 0.390386593032832, 0.384226444884684,
0.379855212561451, 0.376328667106905, 0.374643636803875, 0.374059151955390, 0.374722970137207, 0.378548182258418,
0.385153576197811, 0.398815636803868, 0.417622545894776, 0.442826404480633, 0.474328970137197, 0.511791697409922,
0.553195353975572, 0.599257798420019, 0.652782397746615, 0.719490788318994, 0.797876909531110, 0.888201286635493,
0.977680586298792, 1.082783353975535, 1.193547623335808, 1.313228896063079, 1.435677704143894, 1.575886478554653,
1.711088424682592, 1.846141071147255, 1.978688370810553, 2.121110202460375, 2.273033993706166, 2.437416518958685,
2.605810040844211, 2.749293279901460, 2.878055414581598, 3.011889145221327, 3.128487057679250, 3.248832929733116,
3.362627596399784, 3.455430384278588, 3.540021961719671, 3.619042002123711, 3.676530929733142, 3.720059468453691,
3.747954099766827, 3.760070027376262, 3.755665219295461, 3.736719138487386, 3.708891926366174, 3.664441010541270,
3.604159805154076, 3.527575557679334, 3.438033874177650, 3.335986747915032, 3.234151252965536, 3.135555421315700,
3.031275185625463, 2.914518734447023, 2.798651071147369, 2.680363064413359, 2.567503327039606, 2.440453347241640,
2.309203744548048, 2.190426970137261, 2.062578741181030, 1.942872889329166, 1.837182175524465, 1.729734229396513,
1.626350168790444, 1.520216404480680, 1.434172694042972, 1.349345104817380, 1.272492054312317, 1.196237347241614,
1.124821535793806, 1.061599845558113, 1.000314758016015, 0.946885185625449, 0.894741791686053, 0.846916217611976,
0.800860007174258, 0.758318182258432, 0.722178296736551, 0.687835407847660, 0.656791158689405, 0.628247926366175,
0.599695926366175, 0.575193426366175, 0.550998646904891, 0.529145852292099, 0.508234370810617, 0.487643212561458,
0.467003502123744, 0.447321461719706, 0.426934720978967, 0.410127380911624, 0.394251502123744, 0.377679555995800,
0.361538303470547, 0.346609374177618, 0.331366781585022, 0.319779192359434, 0.304696347241591, 0.293457832090073,
0.280660707510949, 0.265359165423409, 0.251380364076607, 0.236700626702869, 0.224148776534517, 0.213043636803878,
0.203432458352700, 0.194937906164147, 0.187043039160779, 0.179267833773573, 0.173304737813977, 0.167047205827445,
0.162893508857747, 0.158874909531148, 0.154199488655728, 0.147701495389735, 0.140777784952025, 0.133413347241587,
0.128207050945290, 0.124642397746635, 0.121964625019363, 0.119562337140574, 0.116996013908252, 0.114084727712966,
0.111931300103537, 0.108546444884683, 0.107682353975592, 0.106988000440238, 0.105991498756736, 0.105929475187712,
0.103330020642259, 0.101549360709599, 0.099504593032831, 0.098054559362797, 0.098189005490743, 0.095920635120373,
0.094038815255053, 0.091718768117006, 0.089698379228117, 0.087779231079969, 0.086886229396467, 0.085125481921720,
0.083576027376265, 0.081233219295457, 0.080075468453705, 0.079002555995794, 0.078897252965490, 0.078789924682662,
0.075192734446973, 0.072639525692764, 0.069832044211283, 0.066811657005895, 0.065251454985693, 0.064016616601854,
0.062800887645625, 0.062433862393100, 0.060950747914986, 0.061031747914985, 0.059425057679295, 0.059211630069867,
0.056837529059768, 0.055943518958755, 0.057120747914985, 0.056055273167510, 0.055331729396467, 0.054289210877948,
0.054811683941921, 0.052995044211282, 0.051729603133840, 0.050631394379632, 0.049577880911619, 0.047673525692763,
0.046908273167511, 0.044431047578286, 0.042032571147309, 0.039634337140574, 0.038566391012628, 0.036364148588387,
0.034842970137208, 0.032894835457073, 0.033524823672561, 0.033159259699497, 0.033052828723065, 0.033906848925086,
0.033062246231484, 0.032470150271888, 0.031257441517679, 0.030057997073235, 0.028710889329128, 0.026626315255053,
0.026291926366163, 0.027506323672559, 0.028908995389732, 0.027669310204547, 0.028312970137207, 0.028517475187712,
0.027882377544616, 0.026005266433504, 0.026408108184345, 0.025861727712965, 0.026316500440237, 0.027361037477273,
0.028477778218015, 0.028943852292089, 0.029546185625422, 0.029582444884682, 0.030681670473908, 0.030229889329126,
0.031626616601853, 0.031646478554715, 0.031540889329127, 0.031752700776937, 0.031009407847645, 0.031110236130473,
0.029111630069869, 0.026547852292090, 0.025463037477275, 0.023922518958757, 0.023232000440238, 0.021633555995795,
0.019463630069868, 0.019883407847644, 0.020013222662460, 0.019237778218016, 0.017873852292089, 0.016960444884683,
0.016522815255052, 0.018386963403200, 0.019516741180978, 0.020675185625421, 0.023222518958756, 0.022532963403200,
0.024104518958756, 0.023420963403201, 0.024021555995792, 0.026108074514311, 0.024402296736535, 0.022218074514311,
0.019566444884684, 0.017772741180978, 0.016877555995793, 0.017641259699496, 0.018054815255052, 0.017862074514312,
0.018525852292089, 0.019023778218016, 0.018678667106904, 0.018136296736534, 0.018243926366164, 0.017153185625423,
0.016880518958756, 0.016113259699497, 0.015766815255052, 0.018164667106903, 0.017649555995793, 0.018326296736533,
0.018840074514311, 0.018837852292089, 0.019341926366163, 0.019448370810609, 0.017850222662460, 0.017502741180979,
0.016344444884682, 0.015668667106904, 0.016292000440237, 0.016556667106904, 0.017426667106904, 0.015845926366165,
0.012256512224750, 0.012070074514312, 0.012631616601853, 0.014379407847644, 0.014718323672561, 0.014277192359429,
0.014803192359429, 0.015169010541248, 0.015838896063133, 0.016877791686028, 0.018082795053032, 0.018139283268520,
0.018645064413301, 0.018098788319026, 0.016794759699497, 0.017870394379631, 0.017704323672561, 0.018685246231483,
0.017525247914986, 0.017781327039564, 0.015598471820710, 0.014799758015995, 0.014722182258419, 0.014558778218016,
0.013950970137208, 0.013772155322393, 0.012120635120373, 0.011636276534513, 0.011858431416668, 0.012930394379631,
0.013366694042931, 0.013714296736533, 0.013704364076601, 0.013470596399834, 0.012936074514312, 0.012964502123739,
0.012065587982325, 0.012781444884682, 0.012414007174244, 0.013120397746634, 0.014447397746634, 0.015647619968857,
0.015843111551349, 0.015075182258419, 0.013637933100171, 0.012830589665828, 0.011356586298824, 0.011170801787039,
0.011649965086702, 0.012190387645624, 0.014531946568183, 0.013644199093436, 0.011831187308925, 0.010203582931821,
0.008990470137207, 0.009679219295456, 0.011007589665826, 0.012139503807240, 0.011772943201181, 0.010957188992426,
0.009640490339228, 0.010127926366162, 0.009578589665827, 0.010179695726432, 0.008963872494111, 0.006820567780306,
0.006446965086702, 0.007104360709597, 0.009015973504209, 0.009189401113638, 0.008272505490743, 0.008615404480641,
0.009395246231483, 0.009893539160776, 0.011466081248318, 0.012537986972224, 0.013545325356063, 0.012931532426769,
0.013776377544614, 0.014323278218016, 0.012813951618690, 0.011266821989059, 0.010133259699497, 0.008246741180979,
0.007060370810608, 0.007763981921719, 0.010335508857745, 0.010464778218015, 0.010466389329126, 0.011048222662460,
0.010663677207914, 0.011015912898150, 0.011340518958756, 0.009857475187713, 0.009770000440237, 0.009067353975592,
0.008363259699496, 0.010302741180978, 0.010048296736533, 0.012402185625423, 0.013235953302190, 0.013567407847644,
0.014584963403201, 0.015328781585018, 0.016679960036197, 0.015422417948656, 0.014312963403200, 0.013469313571551,
0.012635145221383, 0.010857098083336, 0.009740660372898, 0.010035003807240, 0.011552027376263, 0.011458633436871,
0.012077832090069, 0.012391175524412, 0.012573099766837, 0.012625017275254, 0.012713926366163, 0.013736855659092,
0.014699293369530, 0.014116096399834, 0.014575752965490, 0.016035954985691, 0.016261481921718, 0.015555252965490,
0.014883333773571, 0.013783443201181, 0.012976259699497, 0.012488431416669, 0.011655130069867, 0.012637466770203,
0.014035130069868, 0.014418510541246, 0.017186949935186, 0.019109643537880, 0.020526419632156, 0.021532949935187,
0.021553535793773, 0.020628377544615, 0.019344478554717, 0.017797497073234, 0.017976539160776, 0.017084630069868,
0.016372990339227, 0.018782943201179, 0.020975135120371, 0.022054034110271, 0.021818204143942, 0.020204101450338,
0.020804316938554, 0.020690606500843, 0.022448195726432, 0.024527488655724, 0.025960290002527, 0.026119328723065,
0.027558922999160, 0.027723732763471, 0.028103731079967, 0.029718675524412, 0.030542357342594, 0.029822640170878,
0.028847704143941, 0.029691429733166, 0.030122111551348, 0.031678438150674, 0.032290035793773, 0.031980731079968,
0.032301709194447, 0.031685271484008, 0.032227172157409, 0.031018552628790, 0.028842667106905, 0.026237111551349,
0.024923917948655, 0.023592736130474, 0.023788032426769, 0.022436990339228, 0.020740493706231, 0.020595690675927,
0.019981313571551, 0.019183798420036, 0.019153535793773, 0.017453052628790, 0.016922653638890, 0.017069434783672,
0.017322290002527, 0.018017367443605, 0.018132054312291, 0.016393852292091, 0.014772786635524, 0.013108244547983,
0.011146619968857, 0.010841468453706, 0.009524320305558, 0.009432593032830, 0.010065091349328, 0.010453731079968,
0.011304121652358, 0.011048685625423, 0.009649912898150, 0.009354694042932, 0.007722407847645, 0.006546160372898,
0.005413741180979, 0.005041266433503, 0.005795167106904, 0.005413436467173, 0.006108121652359, 0.005967463403200,
0.005926269800508, 0.007011259699496, 0.008954801787038, 0.009531933100170, 0.010718029059766, 0.009757539160777,
0.007150034110272, 0.005180000440238, 0.004799111551348, 0.005142795053032, 0.005277369127106, 0.004528364076601,
0.007589180574917, 0.007827327039564, 0.007658613234850, 0.007328904480642, 0.005572828723066, 0.004288981921719,
0.002421576197814, 0.002591279901516, 0.004165981921719, 0.004217259699497, 0.003638889329126, 0.004604444884682,
0.004291315255052, 0.005241185625423, 0.003601904480642, 0.002081722662460, 0.000662215928453, 0.002063998756736,
0.001136404480642, 0.001727481921718, 0.003586337140574, 0.004716705827444, 0.004397630069867, 0.004611333773570,
0.004786741180978, 0.004887630069868, 0.004076796736533, 0.005333185625423, 0.003526555995793, 0.004389000440237,
0.004378889329126, 0.006149481921718, 0.005668815255053, 0.003943407847645, 0.004131185625423, 0.003241148588387,
0.002711481921719, 0.002047481921720, 0.001702722662460, 0.000531407847645, 0.001801315255052, 0.003107259699496,
0.002042741180979, 0.004074370810606, 0.007110444884681, 0.009596444884682, 0.010136296736534, 0.008373185625423,
0.006943704143942, 0.005410222662461, 0.004803111551349, 0.004517259699497, 0.003130444884682, 0.003206518958756,
0.002271481921720, 0.004024000440236, 0.005558222662459, 0.006649481921719, 0.006780667106905, 0.006258518958756,
0.004702074514312, 0.003686000440238, 0.003697259699497, 0.002497037477275, -0.000003925485688, -0.000858147707910,
-0.002729703263466, -0.002205332893096, 0.000224889329126, 0.001267852292090, 0.002812222662459, 0.003419778218014,
0.004797926366163, 0.005723185625423, 0.005339926366163, 0.004571259699497, 0.004229333773571, 0.002386889329126,
0.000296889329128, -0.000217110670874, 0.000526296736533, 0.001093778218015, 0.000740741180978, 0.003686815255052,
0.004382000440237, 0.005081333773571, 0.006974296736533, 0.008184222662460, 0.006271481921720, 0.005814889329126,
0.004781259699498, 0.001278370810609, 0.000101407847645, -0.000585999559762, -0.001348740300503, -0.000345258819022,
0.001091926366163, 0.001664000440237, 0.002414741180977, 0.004022074514311, 0.004673555995793, 0.005999778218015,
0.005970667106906, 0.005310000440237, 0.004590222662460, 0.004204889329127, 0.002726148588386, 0.003045852292089,
0.002900222662459, 0.002844518958756, 0.003038593032831, 0.001981778218015, 0.001402889329127, 0.001357185625422,
0.000690667106904, 0.000686815255053, 0.000457481921719, 0.000068667106904, -0.000110787438550, 0.000704667106904,
0.001076101450338, 0.002697502123740, 0.003792808521045, 0.005066909531146, 0.005959859026096, 0.007345428049665,
0.007858175524412, 0.007228869127107, 0.006594424682662, 0.002572269800508, -0.001759120771883, -0.003531103936866,
-0.006266565216327, -0.006189979357742, -0.006131646024408, -0.005101745351009, -0.002454747034512, 0.001153407847643,
0.005134136803873, 0.005907791686029, 0.005795327039564, 0.006268283268521, 0.004602263066501, 0.003379704143942,
0.000916997073234, -0.000480164542927, -0.003484888448651, -0.003868773970537, -0.003634167909931, -0.002029683061446,
-0.002117070266834, 0.000811737813974, 0.001422660372897, 0.002008734446971, 0.003019727712964, 0.002558882595121,
0.000027751281989, -0.002167723465486, -0.002996679694442, -0.003867002926766, -0.001794046697811, -0.001644292489054,
-0.001817938953702, -0.001735952421715, -0.000895366563130, -0.002063534913297, -0.000790585418349, -0.000792975990739,
-0.001461124138887, -0.000007204946968, 0.000256625019362, 0.002060869127105, 0.003273380911618, 0.004957091349328,
0.006187239497476, 0.004875832090070, 0.002498687308925, 0.000529212561451, -0.001459258819021, -0.003200329526091,
-0.004865629189392, -0.006418396866159, -0.006469758819023, -0.005279676327439, -0.004636975990740, -0.004432235249998,
-0.003913427169190, -0.003706565216328, -0.003081077000840, -0.002201864879628, -0.003109110670873, -0.003975683061446,
-0.005187467573229, -0.004691575317338, -0.004255952421716, -0.003229231882995, -0.002821851411615, -0.003637225148988,
-0.004663056798819, -0.004866713364477, -0.003492915384679, -0.003464585418348, -0.002269245351009, -0.001205925485689,
0.000830687308923, 0.002762613234850, 0.003833333773570, 0.001632714244952, -0.000622915384677, -0.002736578684341,
-0.002151258819022, -0.000575851411615, 0.000273704143941, 0.001016963403200, 0.000492168790406, -0.000979999559762,
-0.001578127505889, -0.002752046697810, -0.001511184744949, -0.000613184744947, -0.001932154441916, -0.003011999559761,
-0.004152147707911, -0.003657992825756, -0.002647332893096, -0.001035110670874, 0.001123407847644, 0.001638667106904,
0.001740963403200, 0.002257852292089, 0.003331185625422, 0.003893630069867, 0.002454889329126, 0.001614667106904,
-0.000337703263465, -0.002084740300502, -0.003130740300504, -0.003015184744947, -0.004670666226429, -0.004721332893095,
-0.005739629189392, -0.005371258819022, -0.004754444004207, -0.004342073633836, -0.002671999559764, -0.000061332893096,
-0.000514221781985, -0.002653555115317, -0.003829555115318, -0.005669629189392, -0.005146369930133, -0.004111258819023,
-0.004259406967169, -0.004697258819021, -0.003792888448652, -0.003092962522726, -0.002033703263466, -0.001749481041244,
-0.003506928852691, -0.004140962522725, -0.005231757135520, -0.005271460839224, -0.004419494509258, -0.004775528179291,
-0.004550342994106, -0.004607932219695, -0.004378039963803, -0.002724039963803, 0.000417576197813, 0.001137468453706,
0.001601636803874, 0.000959252965490, 0.001187683941922, -0.000582208313971, -0.000983447371211, -0.000851706630470,
-0.001313171276934, -0.004229730199492, -0.005908767236530, -0.006275534913298, -0.005625797539560, -0.005288019761783,
-0.005343494509257, -0.003881090468854, -0.003259716731480, -0.004013952421715, -0.004218524812288, -0.003437622455386,
-0.002089265553029, -0.001811905283669, -0.001363905283668, -0.002278644340907, -0.002724888448651, -0.001584592152355,
-0.002478390132153, -0.002694019761783, -0.003651077000840, -0.004890033229796, -0.005672396866160, -0.006209240300503,
-0.004751151074915, -0.002481534913298, -0.002181151074914, -0.002074949054712, -0.000901238617002, 0.001064549261786,
0.000423657005894, 0.000619704143941, -0.000680073633836, -0.002138602253365, -0.005391989458751, -0.006040147707911,
-0.004800450738215, -0.003597002926766, -0.002626087101851, -0.000997341310605, -0.000482013027776, 0.000220545894783,
0.002266758015994, 0.002222815255052, 0.002799976871213, 0.001422515591753, 0.000916848925086, -0.000646996192758,
-0.002296060165823, -0.003975130872893, -0.005229026495789, -0.005653545014308, -0.003867245351009, -0.001514120771884,
-0.000372713364477, 0.001206473504210, 0.001827118285355, 0.002492195726433, 0.001400774851012, 0.000439266433504,
-0.001586166226429, -0.001398228515991, -0.001165373297137, -0.001323851411614, -0.003279002926765, -0.004707543330806,
-0.002901097202861, -0.001871898549662, -0.002383811007574, -0.002621895182659, -0.004754871613634, -0.0053878934991570,
-0.005866292489056, -0.004759750401514, -0.003879541647306, -0.002051433903197}; // generated with MATLAB with mean_data(1051:2050) at main_convol_GK_cal2 line: 130
    int i;
    for(i=0; i<1000; i++)
    {
        __npda_avg[i] = npda_avg[i] * 10000.0;
    }

    __npda_conv = __npda_y;
    
    iret = npda_block_end(valid_scans, npda_avg_len, block_cnt);

  	TEST_ASSERT_EQUAL_UINT(0,iret);
  	TEST_ASSERT_FLOAT_WITHIN(0.0001, 0.546969900000000,__thickness[block_cnt]);
  	TEST_ASSERT_FLOAT_WITHIN(0.00001, 0.751125635990480, __PC_weight[block_cnt]);
  	TEST_ASSERT_FLOAT_WITHIN(1.0, 37600.7, __AC_height[block_cnt]);
  	TEST_ASSERT_FLOAT_WITHIN(10000.0, 36974373777.00091, __AC_height_conv[block_cnt]);
}

/* ************************************************************************** */
/** 
 * @brief            npda_measurement_end()
 *
 * @test             This is to test whether the npda_measurement_end()
 *                   function returns correct values when presented with sample
 *                   scan data for all blocks.
 * 
 * @note             None.
 */
/* ************************************************************************** */
void test_npda_measurement_end_correct_data()
{
    int iret;
    fptype thickness;
    fptype sd;
    word blocks;
    
    __thickness[0] = 0.546969900000000;
    __thickness[1] = 0.528784200000000;
    __thickness[2] = 0.538576500000000;
    __thickness[3] = 0.553964400000000;
    __thickness[4] = 0.520390800000000;
    __thickness[5] = 0.538576500000000;
    __thickness[6] = 0.506401800000000;
    __thickness[7] = 0.537177600000000;
    __thickness[8] = 0.524587500000000;
    __thickness[9] = 0.531582000000000;

    __AC_height_conv[0] = 36974373777.00091;
    __AC_height_conv[1] = 31948631555.67147;
    __AC_height_conv[2] = 36318526657.79659;
    __AC_height_conv[3] = 35301863914.85312;
    __AC_height_conv[4] = 11545803723.20235;
    __AC_height_conv[5] = 32710671506.38439;
    __AC_height_conv[6] = 14695439732.26216;
    __AC_height_conv[7] = 38467797130.58895;
    __AC_height_conv[8] = 28667889950.31322;
    __AC_height_conv[9] =  4072291525.79647;

    __AC_height[0] = 37600.70027376262;
    __AC_height[1] = 35770.94837255719;
    __AC_height[2] = 37933.25165472335;
    __AC_height[3] = 37427.29410297197;
    __AC_height[4] = 20122.63361017221;
    __AC_height[5] = 35277.56057294787;
    __AC_height[6] = 20646.25921184636;
    __AC_height[7] = 38440.36254833559;
    __AC_height[8] = 31688.24458933909;
    __AC_height[9] =  9767.24353436579;
    
    __PC_weight[0] = 0.751125635990480;
    __PC_weight[1] = 0.775848184544018;
    __PC_weight[2] = 0.696943267357139;
    __PC_weight[3] = 0.574811706171545;
    __PC_weight[4] = 0.789469629773723;
    __PC_weight[5] = 0.774674434090313;
    __PC_weight[6] = 0.760043321683201;
    __PC_weight[7] = 0.783048440944223;
    __PC_weight[8] = 0.699384066583304;
    __PC_weight[9] = 0.788246551652022;
    
    iret = npda_measurement_end(&thickness, &sd, &blocks);
    
    TEST_ASSERT_EQUAL_INT(110, iret);
    TEST_ASSERT_FLOAT_WITHIN(0.01, 535.5511930018153, thickness);
    TEST_ASSERT_FLOAT_WITHIN(0.001, 10.210599889742706, sd);
    TEST_ASSERT_EQUAL_INT(9, blocks);
}

#endif //TEST_FILE_C
